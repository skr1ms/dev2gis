# Обзор архитектуры

## Архитектура системы

Приложение UAV Heights Map следует упрощенной микросервисной архитектуре, ориентированной на генерацию карт высот (DSM) и ортофотопланов из фотографий БПЛА со следующими компонентами:

### Backend сервисы

#### Go Orchestrator (Оркестратор)
- **Технология**: Go с фреймворком Gin + goswag для документации
- **Порт**: 8080
- **Роль**: REST API оркестратор для обработки запросов на генерацию DSM и ортофотопланов
- **Структура**:
  - `cmd/` - Точка входа приложения
  - `config/` - Управление конфигурацией
  - `internal/` - Упрощенная бизнес-логика
    - `auth/` - JWT аутентификация
    - `heightmap/` - Операции с картами высот и ортофотопланами
    - `storage/` - БД (PostgreSQL + SQLC) и MinIO
  - `pkg/` - Переиспользуемые пакеты (JWT, middleware)
  - `docs/` - Автогенерируемая swagger документация
- **Обязанности**:
  - REST API эндпоинты с swagger документацией
  - JWT аутентификация (регистрация/вход/refresh)
  - Публикация задач в RabbitMQ для Python Workers
  - Управление задачами через БД (PostgreSQL с SQLC)
  - Загрузка фотографий в MinIO

#### Python Workers

**Асинхронные обработчики** (RabbitMQ consumers)
- **Порт**: 8000 (метрики)
- **Роль**: Обработка задач из RabbitMQ очередей
- **Типы обработки**:
  - **Single Worker**: MiDaS depth estimation + улучшения (CLAHE, Edge, Hillshade)
  - **Batch Worker**: NodeODM фотограмметрия (DSM + Ортофотопланы)
- **Зависимости**: OpenCV, NumPy, PyTorch, Pillow, GDAL, pika (RabbitMQ), psycopg2, boto3

### Инфраструктура

- **PostgreSQL**: Основная БД для пользовательских данных и метаданных карт высот
- **MinIO S3 Storage**: Хранилище объектов для файлов и карт высот
  - `uav-data` бакет: Загрузки изображений БПЛА (временное хранение, автоудаление после обработки)
  - `uav-models` бакет: Сгенерированные карты высот (DSM)
  - `uav-photoplanes` бакет: Сгенерированные ортофотопланы
- **RabbitMQ**: Очередь сообщений для асинхронной обработки пакетных задач
  - Очередь `heightmap_tasks`: Одиночная обработка (MiDaS)
  - Очередь `batch_heightmap_tasks`: Пакетная обработка (NodeODM)
  - Автореконнект при разрыве соединения (heartbeat: 15 мин)
- **NodeODM**: Сервис для фотограмметрической обработки (OpenDroneMap)
  - Порт: 3000
  - Генерация DSM и ортофотопланов из множественных изображений с GPS

### Frontend

- **Технология**: React с Next.js 14
- **Порт**: 80 (production), 3000 (development)
- **Возможности**: 
  - Визуализация карт высот и ортофотопланов
  - Загрузка одиночных и пакетных фото
  - Выбор качества обработки (Ультра/Среднее/Низкое)
  - Fast Mode для ускоренной генерации
  - Выбор типа продукта (DSM/Ортофотоплан/Оба)
  - Темная/светлая тема
  - Автообновление токенов (перехват 401)
- **Метрики**: Доступны на эндпоинте `/api/metrics`

## Паттерны коммуникации

- **REST API**: Frontend ↔ Go Orchestrator
- **RabbitMQ**: Go Orchestrator → Python Workers (асинхронные задачи)
- **HTTP API**: Python Workers ↔ NodeODM (фотограмметрия)
- **База данных**: Go Orchestrator ↔ PostgreSQL (SQLC), Python Workers ↔ PostgreSQL (psycopg2)
- **Хранилище объектов**: Все сервисы ↔ MinIO S3 (загрузка, скачивание, автоудаление)
- **Статические файлы**: Frontend ↔ MinIO S3 (прямой доступ к публичным бакетам)
- **Метрики**: Prometheus ↔ Все сервисы (сбор метрик с эндпоинтов)

## Поток данных

### Одиночная генерация (MiDaS)

1. Frontend загружает 1 фото → Go Orchestrator
2. Go сохраняет в MinIO (`uav-data`) → создает задачу в БД → публикует в RabbitMQ
3. Python Worker получает задачу → скачивает фото → обрабатывает MiDaS + улучшения (CLAHE, Edge, Hillshade)
4. Загружает результат в MinIO (`uav-models`) → удаляет исходное фото → обновляет БД
5. Frontend получает публичный URL карты высот

### Пакетная генерация (NodeODM)

1. Frontend загружает 2+ фото + параметры (quality, fast_mode, generation_mode) → Go Orchestrator
2. Go сохраняет в MinIO (`uav-data`) → создает batch задачу → публикует в RabbitMQ
3. Python Worker получает задачу → скачивает все фото
4. **Fast Mode**: Уменьшает изображения до 2000px (сохраняет EXIF/GPS)
5. Проверяет GPS координаты → отправляет в NodeODM с выбранными настройками качества
6. NodeODM обрабатывает фото → генерирует DSM и/или Ортофотоплан
7. Worker извлекает результаты:
   - DSM → конвертирует в PNG с улучшениями → загружает в `uav-models`
   - Ортофотоплан → извлекает GeoTIFF → загружает в `uav-photoplanes`
8. Удаляет все исходные фото из MinIO → обновляет БД со статусом и URL
9. Frontend получает публичные URL для просмотра/скачивания

## Ключевые возможности

- **Одиночная генерация**: MiDaS + CLAHE + Edge Enhancement + Multi-angle Hillshade (~2-5 сек)
- **Пакетная генерация**: NodeODM для фотограмметрии (DSM + Ортофотопланы)
- **3 уровня качества**: Ультра (max), Среднее (average), Низкое (low)
- **Fast Mode**: Уменьшение изображений + флаги оптимизации NodeODM (ускорение до 75%)
- **Генерация ортофотопланов**: Требует ≥5 фото с GPS, хранится в отдельном бакете
- **Автоудаление**: Исходные фото удаляются после успешной обработки
- **Темная/светлая тема**: Полная поддержка на фронтенде с сохранением в localStorage
- **Автообновление токенов**: Перехват 401 ошибок, автоматический refresh, редирект на логин при неудаче
- **RabbitMQ**: Асинхронная очередь с автореконнектом (heartbeat 15 мин)
- **Публичные бакеты**: Прямой доступ к результатам без presigned URL
- **Мониторинг**: Prometheus + Grafana + Loki для метрик и логов
- **Документация API**: Swagger UI на `/swagger/index.html`